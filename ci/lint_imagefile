# Copyright (c) The Bitcoin Core developers
# Distributed under the MIT software license, see the accompanying
# file COPYING or https://opensource.org/license/mit/.

# See test/lint/README.md for usage.

FROM mirror.gcr.io/ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive
ENV LC_ALL=C
ENV PATH="/python_env/bin:${PATH}"
ENV VIRTUAL_ENV="/python_env"
ENV MLC_VERSION=v1

COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/
COPY --from=ghcr.io/astral-sh/ruff:0.14.4 /ruff /bin/
COPY --from=docker.io/koalaman/shellcheck:v0.11.0 /bin/shellcheck /usr/bin/
COPY --from=ghcr.io/astral-sh/ty:0.0.12 /ty /bin/

COPY ./ci/retry/retry /ci_retry
COPY ./.python-version /.python-version

RUN /ci_retry apt-get update && \
  /ci_retry apt-get install -y cargo curl git gpg moreutils && \
  /ci_retry curl -sL "https://github.com/becheran/mlc/releases/download/$MLC_VERSION/mlc-x86_64-linux" -o /usr/bin/mlc && \
  chmod +x /usr/bin/mlc && \
  uv python install && \
  echo 'alias lint="./ci/lint/06_script.sh"' >> ~/.bashrc && \
  rm -rf /var/lib/apt/lists/*

COPY ./ci/lint/container-entrypoint.sh /entrypoint.sh
COPY ./ci/lint/requirements.txt /requirements.txt
RUN uv venv /python_env && \
    uv pip install --python /python_env -r /requirements.txt

WORKDIR /bitcoin
ENTRYPOINT ["/entrypoint.sh"]
